import{e as k,f as T}from"./chunk-SQERYEB6.js";import{c}from"./chunk-OAD3FQTP.js";import{F as m,X as g,_,ca as a,h as d,ia as o,n as i,s as f}from"./chunk-ULGM77ZI.js";import{i as l}from"./chunk-7EPSDV5K.js";var w=(()=>{class s{constructor(){this._httpClient=o(c),this._user=new d(1)}set user(e){this._user.next(e)}get user$(){return this._user.asObservable()}get(){return this._httpClient.get("api/common/user").pipe(_(e=>{this._user.next(e)}))}update(e){return this._httpClient.patch("api/common/user",{user:e}).pipe(f(t=>{this._user.next(t)}))}static{this.\u0275fac=function(t){return new(t||s)}}static{this.\u0275prov=a({token:s,factory:s.\u0275fac,providedIn:"root"})}}return s})();var u=class{static isTokenExpired(r,e){if(!r||r==="")return!0;let t=this._getTokenExpirationDate(r);return e=e||0,t===null?!0:!(t.valueOf()>new Date().valueOf()+e*1e3)}static _b64decode(r){let e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",t="";if(r=String(r).replace(/=+$/,""),r.length%4===1)throw new Error("'atob' failed: The string to be decoded is not correctly encoded.");for(let h=0,p,n,v=0;n=r.charAt(v++);~n&&(p=h%4?p*64+n:n,h++%4)?t+=String.fromCharCode(255&p>>(-2*h&6)):0)n=e.indexOf(n);return t}static _b64DecodeUnicode(r){return decodeURIComponent(Array.prototype.map.call(this._b64decode(r),e=>"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2)).join(""))}static _urlBase64Decode(r){let e=r.replace(/-/g,"+").replace(/_/g,"/");switch(e.length%4){case 0:break;case 2:{e+="==";break}case 3:{e+="=";break}default:throw Error("Illegal base64url string!")}return this._b64DecodeUnicode(e)}static _decodeToken(r){if(!r)return null;let e=r.split(".");if(e.length!==3)throw new Error("The inspected token doesn't appear to be a JWT. Check to make sure it has three parts and see https://jwt.io for more.");let t=this._urlBase64Decode(e[1]);if(!t)throw new Error("Cannot decode the token.");return JSON.parse(t)}static _getTokenExpirationDate(r){let e=this._decodeToken(r);if(!e.hasOwnProperty("exp"))return null;let t=new Date(0);return t.setUTCSeconds(e.exp),t}};var B=(()=>{class s{constructor(){this._authenticated=!1,this._httpClient=o(c),this._userService=o(w),this._apiService=o(T),this._cryptoService=o(k)}set accessToken(e){localStorage.setItem("accessToken",e)}get accessToken(){return localStorage.getItem("accessToken")??""}forgotPassword(e){return this._httpClient.post("api/auth/forgot-password",e)}resetPassword(e){return this._httpClient.post("api/auth/reset-password",e)}signIn(e){return l(this,null,function*(){try{let t=yield this._apiService.post("/auth/login",e);if(t.message==="Login successful")return this.accessToken=t.token,this._cryptoService.setItem("accessToken",t.token),this._cryptoService.setItem("userRole",t.user.role),t.user.division_id&&this._cryptoService.setItem("divisionId",t.user.division_id),localStorage.setItem("id",t.user.id),this._authenticated=!0,this._userService.user=t.user,t;throw new Error("Login failed")}catch(t){throw console.error("Login error:",t),t}})}signInUsingToken(){return this._httpClient.post("api/auth/sign-in-with-token",{accessToken:this.accessToken}).pipe(m(()=>i(!1)),g(e=>(e.accessToken&&(this.accessToken=e.accessToken),this._authenticated=!0,this._userService.user=e.user,i(!0))))}signOut(){return localStorage.removeItem("accessToken"),this._authenticated=!1,i(!0)}signUp(e){return this._httpClient.post("api/auth/sign-up",e)}unlockSession(e){return this._httpClient.post("api/auth/unlock-session",e)}check(){return this._authenticated?i(!0):this.accessToken?u.isTokenExpired(this.accessToken)?i(!1):this.signInUsingToken():i(!1)}static{this.\u0275fac=function(t){return new(t||s)}}static{this.\u0275prov=a({token:s,factory:s.\u0275fac,providedIn:"root"})}}return s})();export{u as a,w as b,B as c};
